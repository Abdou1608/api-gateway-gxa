# Workflows CI/CD

## Vue d'ensemble

Ce dossier contient une configuration GitHub Actions modulaire et sécurisée pour le projet `api-gateway` (Node.js / TypeScript). Aucun script existant n'a été modifié.

| Workflow | Fichier | Déclencheurs | Objectif | Permissions |
|----------|---------|--------------|----------|-------------|
| CI | `.github/workflows/ci.yml` | push/pull_request sur `master`, paths filtrés, dispatch | Install, lint, tests, build, artefacts | contents:read, pull-requests:read |
| CodeQL | `.github/workflows/codeql.yml` | push, PR, schedule hebdo, dispatch | Analyse sécurité statique | contents:read, security-events:write |
| Audit | `.github/workflows/audit.yml` | schedule hebdo, dispatch | Audit dépendances (npm audit) | contents:read |
| Release | `.github/workflows/release.yml` | tag `v*.*.*`, dispatch | Build prod + release GitHub | contents:write |

> Pas d'e2e.yml généré: aucun outil Cypress/Playwright détecté.

## Détection effectuée
- Package manager: npm (présence de `package-lock.json`).
- Tests: dossier `tests/` avec Jest (config fichier `jest.config.cjs` vide mais `npm test` doit être défini/à compléter). Karma / Angular / Nx non détectés (`angular.json` absent, `nx.json` absent).
- Pas de `cypress` ni `playwright.config.*` → pas de workflow e2e pour l'instant.

## Détails principaux
### 1. CI (`ci.yml`)
- Filtrage de chemins pour éviter exécutions inutiles.
- Concurrency empêche duplication sur même ref.
- Détection dynamique du package manager (npm / yarn / pnpm).
- Lint, tests (Jest) et build conditionnels.
- Artefact `dist` si présent.
- Audit sécurité non bloquant (npm audit --audit-level=high).
- Résumé ajouté dans `$GITHUB_STEP_SUMMARY`.

### 2. CodeQL (`codeql.yml`)
- Analyse JavaScript + TypeScript hebdomadaire + sur PR/push.
- Permissions minimales + `security-events: write`.

### 3. Audit (`audit.yml`)
- Installation avec `--ignore-scripts` pour réduire surface d'attaque.
- Export JSON + résumé filtré (vulnérabilités par package).

### 4. Release (`release.yml`)
- Déclenché sur tags `vMAJOR.MINOR.PATCH`.
- Archive `dist.tar.gz` jointe à la release.
- Peut servir ensuite pour une étape de déploiement (OIDC) ultérieure.

### 5. Dependabot (`dependabot.yml`)
- npm: quotidien 03:00 UTC (groupé).
- GitHub Actions: hebdo.
- Regroupement mineur/patch.

## Badges (ajoutez-les dans votre README principal si souhaité)

```
![CI](https://github.com/Abdou1608/api-gateway-gxa/actions/workflows/ci.yml/badge.svg)
![CodeQL](https://github.com/Abdou1608/api-gateway-gxa/actions/workflows/codeql.yml/badge.svg)
![Audit](https://github.com/Abdou1608/api-gateway-gxa/actions/workflows/audit.yml/badge.svg)
```

## Ajout futur: E2E
Pour ajouter un workflow e2e:
1. Ajouter Cypress (`devDependencies`) et un dossier `cypress/` ou Playwright (`playwright.config.ts`).
2. Créer `.github/workflows/e2e.yml` inspiré de la CI avec installation navigateurs (`npx playwright install --with-deps`).
3. Uploader `cypress/videos`, `cypress/screenshots` ou `playwright-report` en artefacts.

## Sécurité & Durcissement
- Permissions par défaut en lecture.
- Concurrency pour éviter collisions.
- `npm ci` (déterminisme) + option `--ignore-scripts` dans audit/release pour réduire surface.
- Pas de secrets exposés (Release utilise GITHUB_TOKEN implicite).
- CodeQL pour détection vulnérabilités statiques.

## OIDC (Déploiement Cloud futur)
Pour un déploiement vers un cloud (AWS / Azure / GCP) sans secret long-terme:
1. Créer un rôle cloud avec trust policy GitHub OIDC.
2. Ajouter une étape `aws-actions/configure-aws-credentials` (ou équivalent Azure/GCP) dans un workflow `deploy`.
3. Restreindre par conditions (`if: github.ref == 'refs/heads/master'`).

## Branch Protection (à configurer côté GitHub)
- Activer protection sur `master`.
- Exiger: statut CI, CodeQL.
- Optionnel: exiger approbation après mise à jour.

## Extension possible
- Ajout d'un workflow `lint-only` rapide sur pull_request_target.
- Intégration `osv-scanner` supplémentaire dans audit.
- Publication d'image Docker multi-arch (`docker buildx`) dans release.

## Questions fréquentes
**Q: Le build échoue car le script postinstall est nécessaire.**
A: Retirez `--ignore-scripts` dans le workflow concerné.

**Q: Comment ajouter une variable d'environnement?**
A: Repo Settings → Secrets and variables → Actions → New repository variable.

**Q: Comment limiter le déclenchement aux dossiers backend seulement?**
A: Ajuster `paths:` dans `ci.yml`.

## Maintenance
- Surveillez les PR Dependabot.
- Vérifiez CodeQL régulièrement.
- Ajoutez des tests pour augmenter la confiance.

---
Generated by automated assistant to bootstrap secure CI/CD.
